---
title: Временные ряды
created: 2025-10-06
tags:
  - ml
  - time_series
links:
---
>[!definition] Временные ряды
>значения меняющихся во времени признаков, полученные в некоторые моменты времени.

![[ts_4586b0902c_3f22fd0ec7.webp]]

### Задача прогнозирования

Пусть $(y_{t},t\in \mathbb{N})$ - временной ряд, для которого известны значения $y_{1},\dots,y_{T}$. Требуется построить *прогноз* - функцию $f$, такую что величина $\hat{y}_{T+h}=f(y_{1},\dots,y_{T},h)$ как можно лучше приближает значение $\hat{y}_{T+h}$, где $h\in \{ 1,\dots,H \}$ - количество шагов, на которое нужно построить прогноз, а величина $H$ - горизонт прогнозирования, то есть максимально е количество шагов для построения прогноза. Иными словами, прогноз значения ряда в момент времени $T+h$ строится на основе известных значений ряда до момента времени $T$. Кроме этого имеет смысл строить *предсказательный интервал*, то есть интервал $(d_{T+h},u_{T+h})$, т.ч. $\mathbb{P}(d_{T+h}\leq y_{T+h}\leq u_{T+h}) \geq \alpha$
## Прогнозирование с помощью сведения к задаче регрессии

![[ts_predict_df49cf88a0_2a78d25310.webp]]
Мы знаем значения ряда (зеленые) до момента времени $t$. Мы бы хотели предсказать (синие) будущее значения ряда (оранжевые).

Основная идея - подадим значения ряда в какую-то регрессионную функцию, получив тем самым предсказания. При этом модель может брать  не все известные значения ряда, а только $p$ последних:
$$y_{t}=f(y_{t-1},\dots,y_{t-p}),$$
где $f$ - произвольная функция.
### Признаки
#### Общий принцип

На практике при генерации идей о том, какие признаки надо можно создавать для построения модели, рекомендуется строить следующий график.
![[1_rgb_split_rooster_902d9298d4_8020007396.svg]]
На нём нужно отметить $t$ и мысленно поставить себя в этот момент времени. Затем нужно подумать какие данные нам доступны. В модель можно брать любые признаки, которые доступные к времени $t$. Если все данные поступают сразу, то можно брать все признаки, которые зависят только от значений до момента времени $t$. В реальности часть данных может поступать с задержкой. Например, если данные загружаются в базу данных раз в сутки в полночь, то в полдень нам не доступны данные за последние 12 часов.

Также нужно понимать, на сколько времени вперед нужно делать прогноз.

#### Даты

Посмотрим на то, какие признаки нужно уметь извлечь. Пусть дана какая-то дата: **13.04.2021 09:00**.
Отсюда можно получить следующие признаки:
- день недели $[2]$
- месяц $[4]$
- год: $[2021]$
- сезон: $[\text{весна}]$
- праздник: $[\text{0}]$
- час: $[9]$

#### Предыдущие значения ряда

Например, если мы хотим построить признаки в момент времени $t$ для прогнозирования $y_{t}$, то можно рассмотреть в качестве признаков $p$ предыдущих значений ряда.
![[Pasted image 20251006081959.png]]
Для реализации таких признаков можно выполнить сдвиги **вперед** временного ряда на $1,2,\dots,p$ шагов. Например, в таблице прогнозирования значений ряда мы рассматриваем два предыдущих значений ряда, выполняя тем самым два шага сдвига вперед.
![[1_rgb_split_rooster_copy_127d9b7e45_0e438ecc93.svg]]

#### Скользящее окно

Не всегда имеет смысл в качестве признаков брать в чистом виде все предыдущие значения ряда. Вместо этого по предыдущим значениям ряда $y_{t-1},\dots,y_{t-p}$ можно посчитать:
- среднее;
- взвешенное среднее;
- экспоненциальное сглаживание;
- медиана;
- минимум/максимум;
- стандартное отклонение;
- Другое.
#### Сезонность

Если во временном ряду наблюдается сезонность, то стоит использовать сезонные признаки, например, следующие:
- Значение переменной сутки/неделю/месяц/год назад. Такие факторы можно усреднять.
- Сезонность, полученная методами декомпозирования ряда.
#### Счётчики

Идея состоит в том, чтобы группировать данные не только по временным меткам, но и по любым категориальным. Можно рассматривать сразу несколько факторов.
#### Резюме
- Используются только данные из прошлого
- Большое количество информации может привести к проблемам;
- Можно генерировать и другие признаки с учетом знаний о предметной области.

### Построение прогнозирования

Пусть требуется построить прогноз на $H$ шагов вперед. Выделяют 3 стратегии для построения прогнозов:
- [[#Рекурсивная стратегия]];
- [[#Прямая стратегия]];
- Гибридная стратегия.

#### Рекурсивная стратегия

Для каждого момента времени $t_{0}\leq t\leq T$ создается объект обучающей выборки:
- *Признаковое описание* - история ряда до момента времени $t-1$
- *Целевая метка* - значение $y_{t}$.

По этим данным мы обучаем какую-либо регрессионную модель строить прогнозы на один шаг вперёд. При построении прогноза на несколько шагов вперёд, мы с сначала построим предсказание на один шаг вперед. Затем - на второй шаг, используя полученный прогноз как признак, и далее аналогично.

![[recursive_8427cc778b_923a246e65.webp]]

#### Прямая стратегия

В данной стратегии подразумевается, что построением прогноза в рамках горизонта прогнозирования должна заниматься своя модель. Тем самым создается $H$ моделей прогнозирования для каждого момента времени $t_{0}\leq t\leq t_{0}+H-1$.
- *Признаковое описание* - история одного ряда до момента времени $t_{0}-1$, причём признаки одни и те же для каждой модели.
- *Целевая переменная* - значение $y_{t}$

![[direct_7ff22dabcb_ba7c98a644.webp]]

#### Гибридная стратегия

Данная стратегия объединяет в себе преимущества рекурсивной и прямой стратегии. Как и в прямой стратегии обучается $H$ моделей, при этом каждая следующая модель использует прогнозы предыдущей в качестве признаков, как в рекурсивной стратегии.

Признаковое описание:
 - история ряда до момента времени $t_{0}-1$
 - предсказания предыдущих моделей для $t_{0},t_{0}-1,\dots,t-1$

![[hybrid_8f9dd2444d_70893afe15.webp]]

#### Модели для нескольких рядов

В реальности нужно прогнозировать сразу несколько временных рядов.
Проблема:
- модель на каждый временной ряд - слишком много ресурсов и не масштабируемо;
- мало моделей - плохие предсказания для каждого ряда по отдельности.

Для решения этой проблемы можно создавать модели для временных рядов, разделённых по категориям, как и разделить объекты по ним.

![[cluster_model_444955a517_8bd1eedf81-1.webp]]

## Декомпозиция временных рядов

>[!definition] Декомпозиция - процедура разложения временного ряда на три временных компоненты:
>-  **Тренд** $T_{t}$ - плавное долгосрочное изменение временного ряда.
>- **Сезонность** $S_{t}$ - циклические изменения временного ряда с постоянным периодом сезонности $s$.
>- **Ошибка** $R_{t}$ - непрогнозируемая случайная компонента ряда.

Можно рассматривать аддитивную декомпозицию, в которой ряд представляется в виде $y_{t}=T_{t}+S_{t}+R_{t}$, а также мультипликативную в виде $y_{t}=T_{t}\cdot S_{t}\cdot R_{t}$. Нетрудно понять, что для построения мультипликативного разложения достаточно выполнить аддитивную декомпозицию для ряда $\log y_{t}$.

### Декомпозиция на основе скользящего среднего

Пусть $s$ - известный заранее период сезонности. Компоненты разложения вычисляются последовательно по следующим правилам.
- **Тренд**
	Вычисляется с помощью скользящего окна длины $s:T_{t}= \frac{1}{s}\sum_{i=t-s/2}^{t+s/2}y_{i}$
- **Сезонность**
	Усреднение значений по сезону после удаления тренда.
	- Вычитаем тренд $y_{t}:=y_{y}-T_{t}$;
	- Формируются $s$ подгрупп $G_{i}=\{ y_{i},y_{i+s},\dots,y_{i+ks} \}$;
	- $i$-е значение сезонности вычисляется усреднением по $i$-ой группе $S_{i}=\overline{G_{i}}$
- **Ошибка**
	$$R_{t}=y_{t}-T_{t}-S_{(t\mod s)}$$.

![[ex_3_stl_c09e4ba22c_fec382cf63.webp]]

### STL-декомпозиция

Название метода расшифровывается как Seasonal-Trend decomposition using LOESS. Является более продвинутой моделью для декомпозиции временного ряда.
>[!definition] LOESS
>Взвешенная линейная регрессия, где вес объекта пропорционален расстоянию от него до точек обучающей выборки.

Инициализация тренда $T^{(0)}=0$;
В цикле по $k$ до сходимости:
- Вычитаем из ряда текущее значение тренда $y_{t}:=y_{t}-T_{t}^{(k)}$.
- Формируются $s$ подгрупп $G_{i}=\{ y_{i},y_{i+s},\dots,y_{i+ks} \}$.
- С помощью LOESS в каждой группе в каждый момент времени предсказывается сезонность $S_{t}$.
- Вычитаем из ряда полученную сезонность $y_{t}:=y_{t}-S_{t}$.
- С помощью LOESS предсказывается новое значение тренда $T^{k+1}_{t}$.

*Замечание:* Пропущен шаг работы с выбросами.
![[stl_f3b3a92cd7_343b7feb4d.webp]]

Преимущества STL-декомпозиции:
- Больше настраиваемых параметров, позволяющих подогнать модель под любые данные.
- Сезонная компонента может изменяться с течением времени, и это изменение контролируется пользователем.
- Модель может быть устойчива к выбросам.

### Оценка качества моделей

Для оценки качества моделей прогнозирования временного ряда в основном используются метрики качества регрессии.
- Средняя квадратичная ошибка
	$$MSE= \frac{1}{T-R+1} \sum_{t=R}^{T}(\hat{y}_{t}-y_{t})^{2}.$$
- Средняя абсолютная ошибка
	$$MAE= \frac{1}{T-R+1} \sum_{t=R}^{T}|\hat{y}_{t}-y_{t}|.$$
, где $R$ - начальный момент времени, а $T$ - последний момент времени.
Также используются иные метрики регрессии.

#### Кросс-валидация для временных рядов

Стандартные схемы для кросс-валидации нельзя применять для временных рядов, потому что значения во временных рядах нельзя перемешивать. Существует два способа построить кросс-валидацию на временных рядах.

**Вариант 1:**
- Обучаемся на первых $t$ значениях временного ряда $y_{1},\dots,y_{t}$, прогнозируем следующие $\Delta t$ значений ряда $\hat{y}_{t+1},\dots,\hat{y}_{t+\Delta t}$.
- Обучаемся на $y_{1},\dots,y_{t+\Delta t}$, прогнозируем $\hat{y}_{t+\Delta t+1},\dots,\hat{y}_{t+2\Delta t}$.
- $\dots$
- Обучаемся на $y_{1},\dots,y_{t+(k-1)\Delta t}$, прогнозируем $\hat{y}_{t+(k-1)\Delta t},\dots,\hat{y}_{t+k\Delta t}$
- На каждой итерации считаем ошибки и усредняем.

![[Group_1_df539253d3_78a875d6a0.svg]]

**Вариант 2:**
- Обучаемся на первых $t$ значениях временного ряда $y_{1},\dots,y_{t}$, прогнозируем следующие $\Delta t$ значений ряда $\hat{y}_{1+\Delta t},\dots,\hat{y}_{t+\Delta t}$.
- Обучаемся на $y_{1+\Delta t},\dots,y_{t+\Delta t}$, прогнозируем $\hat{y}_{t+\Delta t+1},\dots,\hat{y}_{t+2\Delta t}$
- $\dots$
- Обучаемся на $y_{1+(k-1)\Delta t},\dots,y_{t+(k-1)\Delta t}$, прогнозируем $\hat{y}_{t+(k-1)\Delta t+1},\dots,\hat{y}_{t+k\Delta t}$.
- Считаем ошибки и усредняем.

![[cross_val2_1f5518a032_b791f27515_1e8335dd56.svg]]

